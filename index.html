<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicLab - Forja tus Hits</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- MIDI Writer JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@2.1.4/build/MidiWriter.min.js"></script>

    <style>
        /* Estilos personalizados y configuraciÃ³n de Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #e0e0e0;
        }
        .gradient-text {
            background: linear-gradient(90deg, #F59E0B, #FF1B6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero-glow {
            box-shadow: 0 0 100px 30px rgba(255, 27, 107, 0.3);
        }
        .card-bg {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .btn-primary {
            background: linear-gradient(90deg, #F59E0B, #FF1B6B);
            color: #000;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 27, 107, 0.4);
        }
        .btn-secondary {
            background-color: transparent;
            border: 2px solid #FF1B6B;
            color: #FF1B6B;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #FF1B6B;
            color: #fff;
        }
        .btn-featured {
            background-color: #F59E0B;
            color: #000;
        }
         .btn-featured:hover {
            background-color: #FBBF24;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.4);
        }
        .featured-plan { 
            border: 2px solid #F59E0B; 
            transform: scale(1.05); 
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
        }
        .modal-backdrop {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background-color: #111;
            padding: 2rem;
            border: 1px solid #FF1B6B;
            width: 90%;
            max-width: 600px;
            border-radius: 1rem;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .loader { border: 4px solid #4B5563; border-top: 4px solid #FF1B6B; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .disabled-tool { opacity: 0.6; }
        .locked-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            cursor: pointer;
        }
        #tool-modal-output {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: normal;
        }
        #tool-modal-output h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #F59E0B;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #tool-modal-output ul {
            list-style: none;
            padding-left: 0;
        }
        #tool-modal-output li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        #tool-modal-output li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #FF1B6B;
        }
        #tool-modal-output strong {
            color: #e0e0e0;
            font-weight: 600;
        }
        .audio-controls button, .download-stem-button {
            background-color: #FF1B6B;
            color: white;
        }
        .file-input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #9CA3AF;
            margin-bottom: 0.5rem;
        }
        .file-input {
            width: 100%;
            background-color: #1F2937;
            border: 1px solid #4B5563;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="fixed w-full z-50 bg-black/80 backdrop-blur-lg border-b border-gray-800">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-black text-white uppercase tracking-widest">SONIC<span class="gradient-text">LAB</span></div>
            <div id="user-status-container" class="flex items-center gap-4">
                <!-- User status will be rendered here -->
            </div>
        </nav>
    </header>

    <!-- Admin Panel -->
    <section id="admin-panel" class="hidden fixed bottom-0 left-0 right-0 bg-gray-900/90 backdrop-blur-sm border-t-2 border-green-500 p-4 z-[1001]">
        <div class="container mx-auto text-center">
            <h3 class="font-bold text-green-400 mb-4 text-lg tracking-widest uppercase">PANEL DE ARQUITECTO</h3>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <div class="w-full md:w-auto">
                    <label for="admin-plan" class="text-xs text-gray-400 block mb-1">Otorgar Plan Vitalicio</label>
                    <select id="admin-plan" class="bg-gray-800 border border-gray-700 text-white rounded px-2 py-2 text-sm">
                        <option value="PRO">PRODUCER</option>
                        <option value="DIAMANTE">ICONO</option>
                    </select>
                </div>
                <div class="w-full md:w-auto">
                     <label for="admin-credits" class="text-xs text-gray-400 block mb-1">AÃ±adir CrÃ©ditos</label>
                    <input type="number" id="admin-credits" placeholder="Ej: 50" class="bg-gray-800 border border-gray-700 text-white rounded px-2 py-2 text-sm w-32">
                </div>
                <button id="admin-generate-link" class="bg-green-600 hover:bg-green-700 text-white font-bold text-sm py-2 px-4 rounded self-end">Generar Enlace MÃ¡gico</button>
            </div>
            <div id="admin-link-container" class="mt-4 hidden">
                <p class="text-sm text-gray-300 mb-2">Copia y envÃ­a este enlace Ãºnico al usuario:</p>
                <div class="flex justify-center gap-2">
                    <input type="text" id="admin-generated-link" readonly class="bg-gray-800 border border-gray-700 text-green-400 rounded px-2 py-1 text-sm w-full max-w-md">
                    <button id="admin-copy-link" class="bg-gray-600 hover:bg-gray-700 text-white font-bold text-sm py-1 px-3 rounded">Copiar</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="pt-24">
        <!-- Hero Section -->
        <section class="text-center container mx-auto px-6 py-16">
            <div class="relative inline-block">
                <div class="absolute -inset-2 hero-glow rounded-full opacity-50"></div>
                <h1 class="relative text-5xl md:text-7xl font-black leading-tight mb-4 text-white uppercase">
                    Forja tus <span class="gradient-text">Hits</span>
                    <br>El Sonido del Futuro
                </h1>
            </div>
            <p class="max-w-3xl mx-auto text-lg md:text-xl text-gray-400 my-8">
                Deja de usar las mismas librerÃ­as que todos. Accede a herramientas de IA Ãºnicas para crear melodÃ­as, flows y estrategias que te pondrÃ¡n en el mapa. El laboratorio que usarÃ­an tus Ã­dolos, ahora en tus manos.
            </p>
            <a href="#pricing" class="btn-primary text-black font-bold py-4 px-8 rounded-full text-lg">
                Empezar a Crear
            </a>
        </section>

        <!-- Tools Section -->
        <section id="tools" class="container mx-auto px-6 py-24">
            <h2 class="text-4xl font-bold text-center mb-12 text-white">El Laboratorio</h2>
            <div id="tools-grid" class="grid md:grid-cols-3 gap-8">
                <!-- Tools will be rendered here by JavaScript -->
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="bg-black/50 py-24">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-bold text-center mb-12 text-white">Acceso al Laboratorio</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Plan PRO Mensual -->
                    <div class="card-bg p-6 rounded-xl flex flex-col h-full">
                        <h3 class="text-2xl font-bold text-white">Plan PRODUCER</h3>
                        <p class="text-gray-400 mb-4">Mensual</p>
                        <p class="text-4xl font-extrabold text-white mb-4">$4.990<span class="text-lg font-medium text-gray-400">/mes</span></p>
                        <ul class="space-y-3 text-gray-300 mb-6 flex-grow">
                            <li class="flex items-center"><b class="text-pink-500 mr-2">âœ“</b><span><b>50 CrÃ©ditos</b> Mensuales</span></li>
                            <li class="flex items-center"><b class="text-pink-500 mr-2">âœ“</b><span>Acceso a Herramientas PRO</span></li>
                            <li class="flex items-center"><b class="text-pink-500 mr-2">âœ“</b><span>Acordes & Email Pitch</span></li>
                            <li class="flex items-center text-gray-500"><b class="mr-2">Ã—</b><span>Herramientas Premium ICONO</span></li>
                        </ul>
                        <a href="https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=61d8e63e69e344e59370fd7e89b96f9c" target="_blank" class="block w-full btn-secondary text-center font-bold py-3 rounded-lg transition duration-300 mt-auto">Suscribirme</a>
                        <div id="qr-pro-mensual" class="bg-white p-2 rounded-lg mt-4 mx-auto w-40 h-40"></div>
                    </div>
                    <!-- Plan ICONO Mensual -->
                    <div class="card-bg p-6 rounded-xl flex flex-col h-full">
                        <h3 class="text-2xl font-bold text-white">Plan ICONO</h3>
                        <p class="text-gray-400 mb-4">Mensual</p>
                        <p class="text-4xl font-extrabold text-white mb-4">$9.990<span class="text-lg font-medium text-gray-400">/mes</span></p>
                        <ul class="space-y-3 text-gray-300 mb-6 flex-grow">
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span><b>CrÃ©ditos Ilimitados</b></span></li>
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span>Acceso a <b>Todas</b> las Herramientas</span></li>
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span>Synth Preset & Marketing</span></li>
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span>Soporte Prioritario 24/7</span></li>
                        </ul>
                        <a href="https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=0b397bb6555942e084ca042e71d2a242" target="_blank" class="block w-full btn-secondary text-center font-bold py-3 rounded-lg transition duration-300 mt-auto">Suscribirme</a>
                        <div id="qr-diamante-mensual" class="bg-white p-2 rounded-lg mt-4 mx-auto w-40 h-40"></div>
                    </div>
                    <!-- Plan PRO Anual -->
                    <div class="card-bg p-6 rounded-xl flex flex-col h-full">
                        <h3 class="text-2xl font-bold text-white">Plan PRODUCER</h3>
                        <p class="text-gray-400 mb-4">Anual <span class="text-green-400 font-bold">(Ahorra 20%)</span></p>
                        <p class="text-4xl font-extrabold text-white mb-4">$49.990<span class="text-lg font-medium text-gray-400">/aÃ±o</span></p>
                        <ul class="space-y-3 text-gray-300 mb-6 flex-grow">
                             <li class="flex items-center"><b class="text-pink-500 mr-2">âœ“</b><span><b>50 CrÃ©ditos</b> Mensuales</span></li>
                            <li class="flex items-center"><b class="text-pink-500 mr-2">âœ“</b><span>Acceso a Herramientas PRO</span></li>
                            <li class="flex items-center"><b class="text-pink-500 mr-2">âœ“</b><span>Acordes & Email Pitch</span></li>
                            <li class="flex items-center text-gray-500"><b class="mr-2">Ã—</b><span>Herramientas Premium ICONO</span></li>
                        </ul>
                        <a href="https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=97bffffdac9c498d8019054a27a79bf1" target="_blank" class="block w-full btn-secondary text-center font-bold py-3 rounded-lg transition duration-300 mt-auto">Asegurar Ahorro</a>
                        <div id="qr-pro-anual" class="bg-white p-2 rounded-lg mt-4 mx-auto w-40 h-40"></div>
                    </div>
                    <!-- Plan ICONO Anual (Recomendado) -->
                    <div class="card-bg p-6 rounded-xl flex flex-col relative featured-plan h-full">
                        <div class="absolute top-0 -translate-y-1/2 w-full flex justify-center"><span class="bg-yellow-500 text-black text-sm font-bold px-4 py-1 rounded-full uppercase tracking-wider">El MÃ¡s Buscado</span></div>
                        <h3 class="text-2xl font-bold text-white mt-4">Plan ICONO</h3>
                        <p class="text-gray-400 mb-4">Anual <span class="text-green-400 font-bold">(Ahorra 20%)</span></p>
                        <p class="text-4xl font-extrabold text-white mb-4">$99.990<span class="text-lg font-medium text-gray-400">/aÃ±o</span></p>
                        <ul class="space-y-3 text-gray-300 mb-6 flex-grow">
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span><b>CrÃ©ditos Ilimitados</b></span></li>
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span>Acceso a <b>Todas</b> las Herramientas</span></li>
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span>Synth Preset & Marketing</span></li>
                            <li class="flex items-center"><b class="text-yellow-400 mr-2">â˜…</b><span>Soporte Prioritario 24/7</span></li>
                        </ul>
                        <a href="https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=0ce6c115290a4a478b00f3b8b0e31f34" target="_blank" class="block w-full btn-featured text-center font-bold py-3 rounded-lg transition duration-300 mt-auto">Obtener Acceso Total</a>
                        <div id="qr-diamante-anual" class="bg-white p-2 rounded-lg mt-4 mx-auto w-40 h-40"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-black border-t border-gray-800">
        <div class="container mx-auto px-6 py-8 text-center text-gray-400">
            <p>&copy; 2025 SonicLab. El Sonido del Futuro.</p>
        </div>
    </footer>

    <!-- MODAL (Solo para herramientas) -->
    <div id="tool-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="tool-modal-title" class="text-2xl font-bold text-white flex items-center gap-3"></h2>
                <button id="close-tool-modal-button" class="close-button">&times;</button>
            </div>
            <p id="tool-modal-description" class="text-gray-400 mb-6"></p>
            
            <!-- Campos especÃ­ficos para las herramientas -->
            <div id="tool-fields-container" class="space-y-4"></div>

            <div id="tool-modal-output" class="mt-4 text-left bg-black p-4 rounded-lg border border-gray-700 min-h-[150px] whitespace-pre-wrap text-gray-300 overflow-y-auto max-h-60"></div>
            
            <div class="flex justify-between items-center mt-6">
                <div id="action-buttons" class="flex items-center gap-4">
                     <button id="tool-modal-submit" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center transition-colors">
                         <span id="tool-modal-submit-text">Generar</span>
                         <div id="tool-modal-loader" class="loader hidden ml-2 !w-5 !h-5 !border-2"></div>
                     </button>
                     <button id="download-pdf-button" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
                         <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                         PDF
                     </button>
                     <button id="download-midi-button" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                         Descargar MIDI
                     </button>
                </div>
                <p id="tool-modal-cost" class="text-sm text-yellow-400 font-semibold"></p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- ================================== ---
            // --- CONFIGURACIÃ“N DE CLAVES DE API ---
            // --- ================================== ---
            // Â¡Listo! Tus claves han sido insertadas. Las herramientas estÃ¡n activas.
            const YOUR_GEMINI_API_KEY = "AIzaSyDplVYI4isScm8-HxeAktZuuq3C1tistSk"; // Clave de Google AI Studio
            const YOUR_REPLICATE_API_KEY = "r8_THfIFuYgxsUSTU97iEg4ldDxFiophEG3bYJlO"; // Clave de Replicate.com
            
            const { jsPDF } = window.jspdf;
            const MidiWriter = window.MidiWriter;
            
            // --- DEFINICIÃ“N DE PLANES Y HERRAMIENTAS ---
            const planDetails = {
                'GUEST': { name: 'Novato', credits: 3 },
                'PRO': { name: 'Producer', credits: 50 },
                'DIAMANTE': { name: 'Icono', credits: Infinity },
                'CREATOR': { name: 'El Arquitecto', credits: Infinity }
            };
            
            // ==================================================================
            // INICIO: ARSENAL DE HERRAMIENTAS DE SONICLAB - VERSIÃ“N Ã‰LITE 10/10
            // ==================================================================
            const allTools = [
                 // --- CATEGORÃA: PRODUCCIÃ“N Y SONIDO ---
                {
                    id: 'mastering-de-elite-ia', name: 'Mastering de Ã‰lite IA',
                    description: 'Sube tu canciÃ³n y una referencia opcional para obtener un master de nivel mundial, listo para la radio.',
                    icon: 'ðŸŽšï¸', requiredPlan: 'DIAMANTE', cost: 15,
                    type: 'hybrid-mastering'
                },
                {
                    id: 'stem-splitter', name: 'Separador de Stems IA',
                    description: 'Sube una canciÃ³n completa y la IA la separarÃ¡ en vocales, bajo, baterÃ­a y otros instrumentos.',
                    icon: 'âœ‚ï¸', requiredPlan: 'DIAMANTE', cost: 20,
                    type: 'replicate-audio-upload',
                    model: 'cjwbw/demucs:25a173108cff36ef9f8043644d81df27ca350000dc30799639a0b16c1753ce03',
                    input: (p) => ({ audio: p.audio_file })
                },
                {
                    id: 'noise-reducer', name: 'Reductor de Ruido IA',
                    description: 'Limpia tus grabaciones de voz o instrumentos eliminando el ruido de fondo no deseado.',
                    icon: 'ðŸ¤«', requiredPlan: 'PRO', cost: 5,
                    type: 'replicate-audio-upload',
                    model: 'b673833a09c638178d951564734411f3575f0483a2b1ef47b1b9a477fd25a3b3',
                    input: (p) => ({ audio: p.audio_file })
                },
                { 
                    id: 'analisis-de-mezcla', name: 'AnÃ¡lisis de Mezcla Ã‰lite', 
                    description: 'Tu ingeniero personal. Recibe un informe detallado y un checklist para sonar profesional.', 
                    icon: 'ðŸ“Š', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un ingeniero de mezcla ganador de Grammys (como Manny Marroquin). Un artista describe su mezcla asÃ­: "${p.descripcion}". Opcionalmente, ha provisto una canciÃ³n de referencia profesional: ${p.referencia || 'ninguna'}. Crea un informe de mezcla que incluya: 1. **DiagnÃ³stico EstratÃ©gico:** Identifica los 2 problemas mÃ¡s probables. 2. **Plan de AcciÃ³n Priorizado:** 4 pasos a seguir en formato de checklist. 3. **Seteos de Plugins (Nivel Pro):** ParÃ¡metros de EQ y CompresiÃ³n para voz y bajo. 4. **El Secreto del Ingeniero (Tip de Oro):** Un truco avanzado de mezcla (automatizaciÃ³n, buses paralelos, etc.) que separarÃ¡ esta mezcla de las demÃ¡s.`
                },
                { 
                    id: 'vocal-preset-ia', name: 'Vocal Preset IA 2.0', description: 'ObtÃ©n la cadena de efectos y seteos exactos para sonar como tus Ã­dolos.', icon: 'ðŸŽ›ï¸', requiredPlan: 'DIAMANTE', cost: 4, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un ingeniero de mezcla de Ã©lite como Jaycen Joshua. Crea una cadena de mezcla vocal para sonar como ${p.artista} usando exclusivamente plugins de ${p.plugins}. La respuesta DEBE ser una guÃ­a profesional y detallada estructurada en: 1. "FilosofÃ­a del Sonido": Explica el carÃ¡cter vocal del artista. 2. "Cadena de Plugins (En Orden)": Una lista numerada de los plugins. 3. "Seteos Detallados": Para CADA plugin, detalla los parÃ¡metros exactos (frecuencias de EQ, ratio de compresiÃ³n, etc.). 4. "El Secreto del Ingeniero": Un truco final no convencional que defina el sonido.`
                },

                // --- CATEGORÃA: COMPOSICIÃ“N Y CREATIVIDAD ---
                {
                    id: 'co-productor-ia', name: 'Co-Productor IA (Topliner)',
                    description: 'Sube tu beat y recibe una melodÃ­a vocal original ("topline") y armonÃ­as en formato MIDI.',
                    icon: 'ðŸ§‘â€ðŸŽ¤', requiredPlan: 'DIAMANTE', cost: 18,
                    type: 'hybrid-topliner'
                },
                {
                    id: 'ai-music-generator', name: 'Generador de MÃºsica IA',
                    description: 'Describe una escena o un sentimiento y la IA compondrÃ¡ una pieza musical original para ti.',
                    icon: 'ðŸŽµ', requiredPlan: 'DIAMANTE', cost: 15,
                    type: 'replicate-audio',
                    model: 'meta/musicgen:7a76a8258b23fae65c5a22debb8841d1d7e816b75c2f24218cd2bd8573787906',
                    input: (p) => ({ prompt: p.prompt, duration: 10 })
                },
                { 
                    id: 'flow-generator', name: 'Flow Generator 2.0', 
                    description: 'Genera chanteos, mÃ©tricas y cadenas de rimas para romper el beat.', 
                    icon: 'ðŸŽ¤', requiredPlan: 'PRO', cost: 1, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un ghostwriter de Ã©lite que ha trabajado con Drake y Kendrick Lamar. Sobre el tema "${p.tema}", genera 8 barras de letra. El flow debe ser de ${p.flow}. La letra debe incluir punchlines complejos y una cadena de rimas multisilÃ¡bicas al estilo de ${p.artista}. La respuesta DEBE incluir: 1. **Letra:** La letra, limpia y profesional. 2. **AnÃ¡lisis EstratÃ©gico:** Por quÃ© esta letra es superior. 3. **Coaching Vocal (Tip de Oro):** Un consejo especÃ­fico sobre la entrega, cadencia o acentuaciÃ³n de una lÃ­nea clave para maximizar su impacto emocional. 4. **Mapa de Cadencia Visual (Texto):** Una representaciÃ³n simple de la cadencia de las primeras 2 barras (ej: | ta ta TA ta | ta ta TA - |).` 
                },
                { 
                    id: 'drum-pattern', name: 'Drum Pattern IA', 
                    description: 'Rompe el beat block. Genera patrones de baterÃ­a potentes y descÃ¡rgalos en formato MIDI.', 
                    icon: 'ðŸ¥', requiredPlan: 'PRO', cost: 2, type: 'gemini-midi',
                    prompt: (p) => `ActÃºa como un productor de beats de nivel Grammy experto en ${p.genero}. Genera un patrÃ³n de baterÃ­a de 2 compases (32 pasos). La respuesta DEBE ser un objeto JSON con una clave "pattern". El valor debe ser un array de objetos, donde cada objeto representa una nota y tiene las claves "note" (nÃºmero MIDI: 36 para Kick, 38 para Snare, 42 para Hi-Hat), "tick" (posiciÃ³n de 0 a 3072, donde 96 ticks = 1 semicorchea), "duration" ('16n'), y "velocity" (de 0 a 1, ej: 0.9). Incluye variaciones de velocity para un groove humano.`
                },
                { 
                    id: 'acordes-para-sample', name: 'Acordes para Sample', 
                    description: 'Â¿Tienes un sample a capella? La IA te da progresiones de acordes y una lÃ­nea de bajo.', 
                    icon: 'ðŸŽ¼', requiredPlan: 'PRO', cost: 2, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un productor y teÃ³rico musical de Ã©lite. Un artista tiene un sample a capella descrito como: "${p.descripcion}". Genera 2 progresiones de acordes. Para cada una, explica por quÃ© funciona. Finaliza con: 1. **LÃ­nea de Bajo Sugerida:** Una lÃ­nea de bajo simple en notaciÃ³n de notas (ej: C2 - G1 - A1 - F1) para la primera progresiÃ³n. 2. **Acorde de Color (Tip de Oro):** Una sugerencia de un acorde de sÃ©ptima o novena para aÃ±adir sofisticaciÃ³n.`
                },
                { 
                    id: 'sonido-unico-ia', name: 'Sonido Ãšnico IA', description: 'Tu productor ejecutivo. Fusiona los estilos de tus Ã­dolos para crear tu propio sonido.', icon: 'ðŸ§¬', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un productor ejecutivo visionario. Un artista quiere crear un sonido que fusione el estilo de "${p.artista1}" con "${p.artista2}". Genera un informe detallado sobre cÃ³mo lograr esta fusiÃ³n. La respuesta debe incluir: 1. "Concepto SÃ³nico": CÃ³mo unir los dos mundos. 2. "Paleta SÃ³nica Detallada": QuÃ© tipo de 808, snare, y textura principal usar. 3. "El Secreto de la FusiÃ³n": Un truco de producciÃ³n especÃ­fico para que la mezcla de estilos funcione y suene original.`
                },
                { 
                    id: 'synth-preset-ia', name: 'Synth Preset IA', description: 'Tu diseÃ±ador de sonido personal. Crea presets Ãºnicos para tus sintetizadores.', icon: 'ðŸŽ¹', requiredPlan: 'DIAMANTE', cost: 3, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un diseÃ±ador de sonido experto. Genera los parÃ¡metros para un preset de sintetizador basado en la siguiente descripciÃ³n: "${p.descripcion}". La respuesta debe incluir: Tipo de Oscilador (Onda), Set de Envolvente (ADSR), PosiciÃ³n del Filtro (Cutoff) y una sugerencia de efecto (FX) para lograr ese sonido.`
                },
                { 
                    id: 'remix-concept', name: 'Remix Concept IA', description: 'Dale una nueva vida a tu tema. La IA diseÃ±a 3 conceptos de remix en diferentes gÃ©neros.', icon: 'ðŸ”€', requiredPlan: 'DIAMANTE', cost: 4, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un productor y DJ de fama mundial. Tienes que remezclar la canciÃ³n "${p.titulo}", que es un ${p.generoOriginal}. Genera 3 conceptos de remix en gÃ©neros diferentes y populares. Para cada concepto, describe: 1. El Nuevo GÃ©nero. 2. El Nuevo BPM. 3. Los Elementos Clave a mantener de la original. 4. Los Nuevos Instrumentos a aÃ±adir.`
                },

                // --- CATEGORÃA: ESTRATEGIA Y NEGOCIO ---
                {
                    id: 'analizador-de-viralidad-ia', name: 'Analizador de Viralidad IA',
                    description: 'Sube un gancho de 15s. La IA lo analiza y te da una puntuaciÃ³n de viralidad y consejos para optimizarlo.',
                    icon: 'ðŸš€', requiredPlan: 'DIAMANTE', cost: 10,
                    type: 'hybrid-virality'
                },
                {
                    id: 'director-de-videos-ia', name: 'Director de Videos IA',
                    description: 'Sube tu canciÃ³n y recibe un concepto de video, un storyboard completo y un keyframe visual generado por IA.',
                    icon: 'ðŸŽ¬', requiredPlan: 'DIAMANTE', cost: 12,
                    type: 'hybrid-video-director'
                },
                { 
                    id: 'modo-genio', name: 'Modo Genio Ã‰lite', 
                    description: 'Recibe un plan creativo completo y dialoga con un mentor de Ã©lite para tu prÃ³ximo hit.', 
                    icon: 'ðŸ§ ', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como ${p.mentor}, un visionario que entiende que la superioridad no estÃ¡ solo en la tÃ©cnica, sino en la estrategia. Un artista te presenta una idea sobre "${p.tema}". Tu misiÃ³n es crear un "Creative Brief" que sea una estrategia para crear un hit que genere lealtad. El brief DEBE incluir: 1. **Concepto Central y Ãngulo Emocional:** Tu visiÃ³n refinada de la idea. 2. **Estructura y 'Flow' Predictivo:** CÃ³mo estructurarÃ­as la canciÃ³n para mÃ¡ximo impacto. 3. **Sonido y ProducciÃ³n (La Ventaja Injusta):** Los 3 sonidos clave que le darÃ­an una ventaja sÃ³nica. 4. **El Secreto del Genio:** Un truco no convencional que harÃ­a la canciÃ³n inolvidable.`
                },
                { 
                    id: 'cover-art-director', name: 'Director de Arte IA', 
                    description: 'Tu director de arte personal. Genera una portada Ãºnica y un kit visual completo para redes sociales.', 
                    icon: 'ðŸŽ¨', requiredPlan: 'DIAMANTE', cost: 8, type: 'gemini-image',
                    prompt: (p) => `ActÃºa como un director de arte de Ã©lite. Para una canciÃ³n titulada "${p.titulo}" del artista "${p.artista}", con un mood "${p.mood}", crea un prompt de imagen extremadamente detallado para un generador de IA como Imagen 3. La respuesta debe ser Ãºnicamente el prompt. Al final, aÃ±ade una secciÃ³n **Kit Visual Completo (Tip de Oro):** con una paleta de 5 colores HEX extraÃ­dos de la idea, y 2 prompts adicionales, uno optimizado para un Spotify Canvas vertical (9:16) y otro para un banner de YouTube (16:9), manteniendo la coherencia visual.`
                },
                { 
                    id: 'marketing-rollout-ia', name: 'Marketing Rollout IA', description: 'Tu jefe de marketing. DiseÃ±a un plan de lanzamiento de 7 dÃ­as para tu prÃ³ximo hit.', icon: 'ðŸ“ˆ', requiredPlan: 'DIAMANTE', cost: 4, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un jefe de marketing de una discogrÃ¡fica. Crea un plan de lanzamiento de 7 dÃ­as para redes sociales (Instagram/TikTok) para la canciÃ³n "${p.cancion}". Detalla una idea de contenido para cada dÃ­a, desde 5 dÃ­as antes del lanzamiento hasta 1 dÃ­a despuÃ©s, para generar el mÃ¡ximo hype. Para el dÃ­a del lanzamiento, escribe el copy exacto de la publicaciÃ³n.`
                },
                { 
                    id: 'storyboard-ia', name: 'Storyboard IA', description: 'Crea un storyboard profesional con 6 escenas clave para el videoclip de tu canciÃ³n.', icon: 'ðŸŽ¥', requiredPlan: 'DIAMANTE', cost: 4, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un director de videoclips. Basado en la siguiente letra, crea un storyboard de 6 escenas clave. Para cada escena, describe: 1. El NÃºmero de Escena. 2. El Tipo de Plano (ej: Plano General, Primer Plano). 3. La AcciÃ³n que ocurre. Letra: "${p.letra}".`
                },
                { 
                    id: 'media-training-ia', name: 'Entrenamiento de Medios IA', description: 'Tu publicista personal. PrepÃ¡rate para cualquier entrevista con respuestas potentes y profesionales.', icon: 'ðŸŽ™ï¸', requiredPlan: 'DIAMANTE', cost: 3, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un publicista y entrenador de medios para artistas de primer nivel. Un artista llamado ${p.artista} va a ser entrevistado sobre su nueva canciÃ³n "${p.cancion}". El mensaje clave es "${p.mensaje}". Genera respuestas profesionales y memorables para estas 3 preguntas comunes: 1. Â¿De quÃ© trata tu nueva canciÃ³n? 2. Â¿CuÃ¡l fue tu inspiraciÃ³n? 3. Â¿QuÃ© es lo siguiente para ti?`
                },
                { 
                    id: 'identidad-de-marca-ia', name: 'Identidad de Marca IA', description: 'Tu director de marca. Crea un "Brand Kit" completo para tu proyecto artÃ­stico.', icon: 'ðŸ’Ž', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un director de marca de una agencia de alto nivel. Crea un "Brand Kit" para un artista. Nombre: "${p.nombre}". Temas clave en su mÃºsica: "${p.temas}". Color principal: "${p.color}". La respuesta debe incluir: 1. "Concepto de Logo". 2. "Paleta de Colores" con 3 cÃ³digos HEX. 3. "TipografÃ­a" (fuente para tÃ­tulos y para texto). 4. "Voz de Marca" (3 palabras clave). 5. "Idea de Merchandising" creativa.`
                },
                { 
                    id: 'global-release-planner', name: 'Global Release Planner', 
                    description: 'Crea una hoja de ruta para lanzar tu mÃºsica en mÃºltiples paÃ­ses.', 
                    icon: 'ðŸŒŽ', requiredPlan: 'DIAMANTE', cost: 6, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un jefe de marketing internacional de Sony Music. Para un lanzamiento de ${p.genero}, crea una estrategia de lanzamiento simultÃ¡neo para ${p.paises}. Para cada paÃ­s, detalla: 1. **DÃ­a y Hora Ã“ptima de Lanzamiento (hora local).** 2. **3 Playlists Editoriales Clave a las que apuntar.** 3. **2 Influencers o Medios de ComunicaciÃ³n locales relevantes para contactar.** 4. **Un Ãngulo Cultural:** Â¿CÃ³mo se puede adaptar el mensaje de marketing para que resuene con la audiencia local?`
                },
                { 
                    id: 'cultural-translator', name: 'Traductor Cultural', 
                    description: 'Adapta tus letras para que conecten culturalmente en otros paÃ­ses.', 
                    icon: 'ðŸŒ', requiredPlan: 'DIAMANTE', cost: 4, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un letrista y experto en localizaciÃ³n cultural. Toma la siguiente letra de ${p.origen} y adÃ¡ptala para el mercado de ${p.objetivo}. No traduzcas literalmente. Reemplaza modismos locales por equivalentes que resuenen en el mercado objetivo. Presenta el resultado en una tabla "Original vs. AdaptaciÃ³n" y aÃ±ade una **Nota de Impacto Cultural (Tip de Oro):** explicando por quÃ© un cambio especÃ­fico es crucial para la conexiÃ³n emocional con la nueva audiencia. Letra: "${p.letra}"`
                },
                { 
                    id: 'royalty-split-simulator', name: 'Simulador de RegalÃ­as', 
                    description: 'Simula el reparto de regalÃ­as de tus canciones antes de colaborar.', 
                    icon: 'ðŸ’°', requiredPlan: 'DIAMANTE', cost: 4, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un business manager de la industria musical. Basado en los siguientes colaboradores y porcentajes: "${p.colaboradores}", calcula las ganancias estimadas para cada parte de un total de ${p.streams} streams en Spotify (usando una tasa promedio de $0.003 USD por stream). Presenta los resultados en una tabla clara que muestre el porcentaje y el monto en dÃ³lares para cada colaborador. AÃ±ade una "Nota del Manager" con un consejo sobre si el reparto es justo y estÃ¡ndar para la industria.`
                },
                { 
                    id: 'contract-analyzer', name: 'Analizador de Contratos', 
                    description: 'Analiza contratos, identifica "banderas rojas" y obtÃ©n palancas para negociar.', 
                    icon: 'âš–ï¸', requiredPlan: 'DIAMANTE', cost: 10, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un abogado experto en la industria musical. Has recibido el siguiente texto de un contrato: "${p.texto}". Tu misiÃ³n NO es dar consejo legal, sino educar al artista. Analiza el texto y genera un informe que incluya: 1. **Resumen Ejecutivo Simple.** 2. **ClÃ¡usulas Clave Explicadas.** 3. **Puntos de Palanca para Negociar (Tip de Oro):** Identifica 2-3 clÃ¡usulas donde un artista independiente tiene mÃ¡s poder para pedir mejores condiciones. 4. **Preguntas Inteligentes para tu Abogado.** 5. **Disclaimer Obligatorio:** Finaliza SIEMPRE con: '**Este anÃ¡lisis es una herramienta educativa y NO constituye asesoramiento legal. Es indispensable que consultes con un abogado cualificado antes de firmar cualquier documento legal.**'`
                },
                 { 
                    id: 'email-pitch', name: 'Email Pitch', 
                    description: 'Tu manager personal. Escribe emails profesionales para contactar a curadores, blogs o sellos.', 
                    icon: 'ðŸ“§', requiredPlan: 'PRO', cost: 1, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un A&R y manager de artistas que entiende la psicologÃ­a de la comunicaciÃ³n. Tu tarea es redactar un email para un ${p.destinatario} para presentar la canciÃ³n "${p.cancion}" del artista ${p.artista}. El email debe ser corto, directo y contrarrestar el "dÃ©ficit de confianza" del mercado. Debe ser hiper-personalizado, no un template. Incluye un llamado a la acciÃ³n claro y el link: ${p.link}. La respuesta debe ser Ãºnicamente el texto del email, listo para copiar y pegar.`
                },
                { 
                    id: 'hook-optimizer', name: 'Hook Optimizer', 
                    description: 'Crea tÃ­tulos y ganchos virales para tus canciones y redes sociales.', 
                    icon: 'ðŸŽ£', requiredPlan: 'PRO', cost: 2, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un director creativo y estratega de contenido viral. Basado en la letra y el tema "${p.tema}", genera: 1. **3 TÃ­tulos Optimizados.** 2. **3 Hooks Virales para TikTok/Reels.** 3. **Audio Viral Potencial (Tip de Oro):** Identifica el fragmento de 5-15 segundos de la letra con el mayor potencial para convertirse en un 'audio' popular en TikTok, explicando por quÃ© (memorable, relatable, etc.).`
                },
                { 
                    id: 'tech-rider-builder', name: 'Tech Rider Builder', 
                    description: 'Crea un Rider TÃ©cnico profesional para tus shows en vivo en segundos.', 
                    icon: 'âš™ï¸', requiredPlan: 'PRO', cost: 3, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un tour manager y tÃ©cnico de sonido experimentado. Un artista llamado "${p.nombre}" (contacto: ${p.contacto}) necesita un Rider TÃ©cnico profesional para su configuraciÃ³n de "${p.configuracion}" en un recinto "${p.recinto}". Genera un Rider TÃ©cnico completo. Al final, aÃ±ade una secciÃ³n **Notas del Tour Manager (Tip de Oro):** con un consejo prÃ¡ctico de adaptaciÃ³n basado en el tamaÃ±o del recinto seleccionado.`
                },
                { 
                    id: 'metadata-generator', name: 'Generador de Metadatos', 
                    description: 'Ahorra tiempo. Genera todos los metadatos y textos necesarios para distribuir tu canciÃ³n.', 
                    icon: 'ðŸ“', requiredPlan: 'PRO', cost: 2, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un especialista en distribuciÃ³n digital. Para la canciÃ³n "${p.titulo}" de ${p.artista} (${p.genero}, mood ${p.mood}), genera la informaciÃ³n lista para una distribuidora. Al final, aÃ±ade una secciÃ³n **Pitch para Playlists EspecÃ­ficas (Tip de Oro):** con un pitch corto y adaptado para las 2 playlists mÃ¡s importantes del gÃ©nero, explicando por quÃ© encaja.`
                },
                { 
                    id: 'trend-forecaster', name: 'Trend Forecaster Ã‰lite', 
                    description: 'AnticÃ­pate a las tendencias y obtÃ©n un plan de acciÃ³n para capitalizarlas.', 
                    icon: 'ðŸ“ˆ', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un analista de datos y 'coolhunter' para una discogrÃ¡fica de primer nivel. Tu misiÃ³n es detectar micro-tendencias antes de que se vuelvan mainstream. Analiza datos emergentes de TikTok, Spotify, y foros de mÃºsica para el mercado ${p.mercado} dentro del gÃ©nero ${p.genero}. Genera un informe de inteligencia predictiva que incluya: 1. **La PrÃ³xima Ola SÃ³nica:** Describe el subgÃ©nero que estÃ¡ ganando tracciÃ³n. 2. **El ADN del Sonido:** Detalla 3-4 elementos sÃ³nicos que lo definen. 3. **Plan de Ataque RÃ¡pido:** Un plan de 3 pasos (Contenido TikTok, ProducciÃ³n, Anuncio) para que un artista pueda capitalizar esta tendencia esta misma semana.`
                },
                { 
                    id: 'collab-architect', name: 'Collab Architect Ã‰lite', 
                    description: 'Encuentra colaboradores reales y obtÃ©n una propuesta de negocio para presentarles.', 
                    icon: 'ðŸ¤', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un A&R y estratega musical de Ã©lite. Para un artista llamado ${p.nombre} con el sonido "${p.descripcion}" y el objetivo de "${p.objetivo}", encuentra 3 colaboradores REALES y ACCIONABLES. Para cada sugerencia, entrega un informe estratÃ©gico: 1. **Artista Sugerido y Sinergia:** Nombre del artista real y por quÃ© su sonido, marca y fans son compatibles. 2. **Concepto Creativo Ganador:** Describe la canciÃ³n que crearÃ­an juntos. 3. **Pitch de ColaboraciÃ³n:** Un borrador del primer mensaje para contactarlo, enfocado en el beneficio mutuo.`
                },
                { 
                    id: 'audience-analyzer', name: 'Audience Analyzer Ã‰lite', 
                    description: 'Convierte tus datos de Spotify en una matriz de contenido estratÃ©gico.', 
                    icon: 'ðŸŽ¯', requiredPlan: 'DIAMANTE', cost: 5, type: 'gemini-text',
                    prompt: (p) => `ActÃºa como un estratega de marketing digital. Has recibido estos datos de Spotify for Artists: Ciudades: "${p.ciudades}". DemografÃ­a: "${p.demografia}". Fuentes: "${p.fuentes}". Playlists: "${p.playlists}". Tu tarea es generar: 1. **Perfil de tu Fan Ideal ("Fan Persona"):** Dale un nombre, edad y motivaciones. 2. **Matriz de Contenido EstratÃ©gico:** Una tabla con ideas de contenido para TikTok, Instagram y YouTube Shorts, diseÃ±adas especÃ­ficamente para conectar con esa "Fan Persona". 3. **PrÃ³ximo Movimiento EstratÃ©gico:** Basado en toda la data, Â¿cuÃ¡l deberÃ­a ser el siguiente paso del artista para crecer?`
                },
            ];
            // ==================================================================
            // FIN: ARSENAL DE HERRAMIENTAS
            // ==================================================================

            // --- ESTADO DE LA APLICACIÃ“N ---
            let userState = { plan: 'GUEST', credits: 3 };

            // --- ELEMENTOS DEL DOM ---
            const dom = {
                userStatusContainer: document.getElementById('user-status-container'),
                toolsGrid: document.getElementById('tools-grid'),
                toolModal: document.getElementById('tool-modal'),
                closeToolModalBtn: document.getElementById('close-tool-modal-button'),
                toolModalTitle: document.getElementById('tool-modal-title'),
                toolModalDescription: document.getElementById('tool-modal-description'),
                toolModalCost: document.getElementById('tool-modal-cost'),
                toolModalOutput: document.getElementById('tool-modal-output'),
                toolModalSubmit: document.getElementById('tool-modal-submit'),
                toolModalSubmitText: document.getElementById('tool-modal-submit-text'),
                toolModalLoader: document.getElementById('tool-modal-loader'),
                downloadPdfButton: document.getElementById('download-pdf-button'),
                downloadMidiButton: document.getElementById('download-midi-button'),
                toolFieldsContainer: document.getElementById('tool-fields-container'),
                adminPanel: document.getElementById('admin-panel'),
                adminPlan: document.getElementById('admin-plan'),
                adminCredits: document.getElementById('admin-credits'),
                adminGenerateLinkBtn: document.getElementById('admin-generate-link'),
                adminLinkContainer: document.getElementById('admin-link-container'),
                adminGeneratedLink: document.getElementById('admin-generated-link'),
                adminCopyLinkBtn: document.getElementById('admin-copy-link')
            };

            // --- INICIALIZACIÃ“N ---
            function init() {
                loadUserState();
                setupQRCodes();
                setupEventListeners();
                updateBranding();
            }
            
            function updateBranding() {
                document.title = 'SonicLab - Forja tus Hits';
                document.querySelector('header .text-2xl').innerHTML = 'SONIC<span class="gradient-text">LAB</span>';
                document.querySelector('footer p').textContent = 'Â© 2025 SonicLab. El Sonido del Futuro.';
                document.querySelector('main h1').innerHTML = 'Forja tus <span class="gradient-text">Hits</span><br>El Sonido del Futuro';
            }

            // --- GESTIÃ“N DE ESTADO DE USUARIO (Sin cambios) ---
            function loadUserState() {
                const urlHash = window.location.hash;
                if (urlHash === '#creator') {
                    userState = { plan: 'CREATOR', credits: Infinity };
                    dom.adminPanel.classList.remove('hidden');
                } else if (urlHash.startsWith('#grant-')) {
                    const parts = urlHash.substring(7).split('-');
                    const plan = parts[0];
                    const credits = parts.length > 1 ? parseInt(parts[1], 10) : Infinity;
                    userState = { plan: plan.toUpperCase(), credits: isNaN(credits) ? Infinity : credits };
                    saveUserState();
                    alert(`Â¡Acceso ${planDetails[plan.toUpperCase()].name} activado! Bienvenido a la Ã©lite.`);
                    window.location.hash = '';
                }
                else {
                    const savedState = localStorage.getItem('sonicLabState');
                    if (savedState) {
                        userState = JSON.parse(savedState);
                    } else {
                        userState = { plan: 'GUEST', credits: 3 };
                        saveUserState();
                    }
                }
                updateUI();
            }

            function saveUserState() {
                if (userState.plan !== 'CREATOR') {
                    localStorage.setItem('sonicLabState', JSON.stringify(userState));
                }
            }

            // --- LÃ“GICA DE LA INTERFAZ (UI) ---
            function updateUI() {
                const planInfo = planDetails[userState.plan] || planDetails['GUEST'];
                const { name } = planInfo;
                let planColorClass = 'text-gray-400';
                if (userState.plan === 'PRO') planColorClass = 'text-pink-500';
                if (userState.plan === 'DIAMANTE') planColorClass = 'text-yellow-400';
                if (userState.plan === 'CREATOR') planColorClass = 'text-green-400';
                
                const creditsText = userState.credits === Infinity ? 'Ilimitados' : `${userState.credits} CrÃ©ditos`;

                dom.userStatusContainer.innerHTML = `
                    <div class="text-right">
                        <p class="font-bold text-white">${name}</p>
                        <p class="text-xs font-semibold ${planColorClass}">${creditsText}</p>
                    </div>
                `;
                renderTools();
            }

            function renderTools() {
                dom.toolsGrid.innerHTML = '';
                allTools.sort((a, b) => {
                    const planOrder = { 'PRO': 1, 'DIAMANTE': 2 };
                    return (planOrder[a.requiredPlan] || 0) - (planOrder[b.requiredPlan] || 0);
                });
                
                allTools.forEach(tool => {
                    const isPremiumTool = tool.requiredPlan === 'DIAMANTE';
                    const canAfford = userState.credits === Infinity || userState.credits >= tool.cost;
                    
                    let hasPlanAccess = false;
                    if (userState.plan === 'CREATOR' || userState.plan === 'DIAMANTE') {
                        hasPlanAccess = true;
                    } else {
                        hasPlanAccess = userState.plan === 'PRO' && !isPremiumTool;
                    }

                    const canGuestTry = userState.plan === 'GUEST' && !isPremiumTool && canAfford;
                    const isEffectivelyDisabled = !(canGuestTry || hasPlanAccess);

                    const toolCard = document.createElement('div');
                    toolCard.className = `card-bg p-6 rounded-2xl text-center transform hover:scale-105 transition-transform duration-300 flex flex-col relative ${isEffectivelyDisabled && !canAfford ? 'disabled-tool' : 'cursor-pointer'}`;
                    
                    let overlay = '';
                    if (isPremiumTool && userState.plan !== 'DIAMANTE' && userState.plan !== 'CREATOR') {
                        overlay = `<div class="locked-overlay" onclick="document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' });"><span class="text-4xl" title="Requiere Plan ICONO">ðŸ‘‘</span></div>`;
                    }
                    
                    toolCard.innerHTML = `
                        ${isPremiumTool ? '<div class="absolute top-4 right-4 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full">ICONO</div>' : ''}
                        <div class="text-5xl mb-4">${tool.icon}</div>
                        <h3 class="text-xl font-bold mb-2 text-white">${tool.name}</h3>
                        <p class="text-gray-400 flex-grow">${tool.description}</p>
                        <p class="text-yellow-400 font-bold mt-4">Costo: ${tool.cost} CrÃ©dito(s)</p>
                        ${overlay}
                    `;
                    
                     toolCard.addEventListener('click', () => {
                         if (isPremiumTool && userState.plan !== 'DIAMANTE' && userState.plan !== 'CREATOR') {
                             alert('Herramienta exclusiva para el plan ICONO. Â¡Sube de nivel!');
                             return;
                         }
                         if (!canAfford) {
                             alert(`CrÃ©ditos insuficientes. Te quedan ${userState.credits}.`);
                             return;
                         }
                         if (!isEffectivelyDisabled || canGuestTry) {
                             openToolModal(tool);
                         }
                     });
                    
                    dom.toolsGrid.appendChild(toolCard);
                });
            }

            // --- LÃ“GICA DE MODALES ---
            function openToolModal(tool) {
                dom.toolModalTitle.innerHTML = `<span class="text-4xl">${tool.icon}</span> ${tool.name}`;
                dom.toolModalDescription.textContent = tool.description;
                dom.toolModalCost.textContent = `Esto usarÃ¡ ${tool.cost} de tus crÃ©ditos.`;
                dom.toolModalOutput.innerHTML = '';
                dom.downloadPdfButton.classList.add('hidden');
                dom.downloadMidiButton.classList.add('hidden');
                
                renderToolInputs(tool);
                
                dom.toolModalSubmit.onclick = () => handleToolExecution(tool);
                dom.toolModal.classList.add('active');
            }

            function renderToolInputs(tool) {
                const container = dom.toolFieldsContainer;
                container.innerHTML = ''; // Limpiar campos anteriores

                if (tool.type === 'replicate-audio-upload') {
                    container.innerHTML = `<input type="file" id="audio-file-input" accept="audio/*" class="file-input">`;
                } else if (tool.type === 'replicate-audio') {
                     container.innerHTML = `<textarea id="tool-prompt-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="3" placeholder="Ej: 80s pop track with synth, high quality, 120bpm..."></textarea>`;
                } else if (tool.type === 'gemini-image') {
                     container.innerHTML = `<input type="text" id="cover-artista" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre del Artista"><input type="text" id="cover-titulo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="TÃ­tulo de la CanciÃ³n"><input type="text" id="cover-mood" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Mood (ej: oscuro, futurista, nostÃ¡lgico)">`;
                } else if (tool.type === 'hybrid-mastering') {
                    container.innerHTML = `
                        <div>
                            <label class="file-input-label" for="user-track-input">1. Sube tu canciÃ³n (WAV, MP3)</label>
                            <input type="file" id="user-track-input" accept="audio/*" class="file-input">
                        </div>
                        <div>
                            <label class="file-input-label" for="reference-track-input">2. Sube una canciÃ³n de referencia (Opcional)</label>
                            <input type="file" id="reference-track-input" accept="audio/*" class="file-input">
                        </div>
                    `;
                } else { // Default for gemini-text tools
                    switch (tool.id) {
                        case 'flow-generator':
                            container.innerHTML = `<input type="text" id="flow-tema" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Tema (ej: lealtad en el barrio)"><select id="flow-tipo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2"><option value="Trap agresivo">Flow: Trap agresivo</option><option value="Reggaeton melancÃ³lico">Flow: Reggaeton melancÃ³lico</option><option value="Drill crudo y directo">Flow: Drill crudo y directo</option></select><input type="text" id="flow-artista" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Artista para cadena de rimas (ej: Duki)">`;
                            break;
                        case 'drum-pattern':
                            container.innerHTML = `<select id="drum-genero" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="Reggaeton">GÃ©nero: Reggaeton</option><option value="Trap">GÃ©nero: Trap</option><option value="Boom Bap">GÃ©nero: Boom Bap</option></select>`;
                            break;
                        case 'acordes-para-sample':
                            container.innerHTML = `<textarea id="acordes-descripcion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="4" placeholder="Describe tu sample (ej: 'una voz femenina melancÃ³lica, tempo lento')"></textarea>`;
                            break;
                        case 'email-pitch':
                             container.innerHTML = `<input type="text" id="pitch-artista" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Tu Nombre de Artista"><input type="text" id="pitch-cancion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre de tu CanciÃ³n"><input type="text" id="pitch-link" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Link a tu canciÃ³n (Spotify, YouTube, etc.)"><select id="pitch-destinatario" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="un curador de playlists de Spotify">Destinatario: Curador de Playlist</option><option value="un blog de mÃºsica urbana">Destinatario: Blog de MÃºsica</option><option value="un sello discogrÃ¡fico independiente">Destinatario: Sello DiscogrÃ¡fico</option></select>`;
                            break;
                        case 'hook-optimizer':
                            container.innerHTML = `<textarea id="hook-tema" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="4" placeholder="Pega aquÃ­ la letra o describe el tema de tu canciÃ³n..."></textarea>`;
                            break;
                         case 'tech-rider-builder':
                            container.innerHTML = `<input type="text" id="rider-nombre" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre del Artista o Banda"><input type="text" id="rider-contacto" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Email o TelÃ©fono de Contacto"><textarea id="rider-configuracion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="3" placeholder="Describe tu formaciÃ³n y equipo clave..."></textarea><select id="rider-recinto" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="Club PequeÃ±o (hasta 100 personas)">Club PequeÃ±o</option><option value="Sala Mediana (100-500 personas)">Sala Mediana</option><option value="Festival o Recinto Grande">Festival / Recinto Grande</option></select>`;
                            break;
                        case 'metadata-generator':
                            container.innerHTML = `<input type="text" id="meta-artista" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre del Artista"><input type="text" id="meta-titulo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="TÃ­tulo de la CanciÃ³n"><input type="text" id="meta-genero" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="GÃ©nero Principal"><input type="text" id="meta-mood" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Mood de la canciÃ³n (ej: energÃ©tico, melancÃ³lico)">`;
                            break;
                        case 'modo-genio':
                            container.innerHTML = `<textarea id="genio-tema" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="3" placeholder="Describe la idea o tema de tu canciÃ³n..."></textarea><select id="genio-mentor" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="Tainy">Mentor: Tainy (ProducciÃ³n)</option><option value="Drake">Mentor: Drake (Letra y Storytelling)</option><option value="The Weeknd">Mentor: The Weeknd (AtmÃ³sfera y Sonido)</option><option value="Bad Bunny">Mentor: Bad Bunny (EnergÃ­a y Flow)</option></select>`;
                            break;
                        case 'analisis-de-mezcla':
                            container.innerHTML = `<textarea id="analisis-descripcion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="4" placeholder="Describe tu mezcla y tus problemas..."></textarea><input type="text" id="analisis-referencia" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="URL de YouTube de referencia (Opcional)">`;
                            break;
                        case 'contract-analyzer':
                             container.innerHTML = `<textarea id="contract-texto" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="8" placeholder="Pega aquÃ­ el texto completo del contrato..."></textarea>`;
                            break;
                        case 'vocal-preset-ia':
                            container.innerHTML = `<select id="vocal-daw" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2"><option value="Plugins Nativos (FL Studio, Ableton, Logic)">Plugins Nativos (Cualquier DAW)</option><option value="Plugins de Waves">Plugins de Waves</option><option value="Plugins de Slate Digital">Plugins de Slate Digital</option></select><input type="text" id="vocal-artista" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Artista de referencia (ej: The Weeknd, Bad Bunny)">`;
                            break;
                        case 'identidad-de-marca-ia':
                            container.innerHTML = `<input type="text" id="brand-nombre" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Tu nombre artÃ­stico"><textarea id="brand-temas" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="2" placeholder="Temas clave en tu mÃºsica (ej: calle, lujo, desamor)"></textarea><input type="text" id="brand-color" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Un color que te represente (ej: morado oscuro)">`;
                            break;
                        case 'sonido-unico-ia':
                            container.innerHTML = `<input type="text" id="sound-artista1" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Primer artista (ej: Tainy)"><input type="text" id="sound-artista2" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Segundo artista (ej: The Weeknd)">`;
                            break;
                        case 'synth-preset-ia':
                            container.innerHTML = `<textarea id="synth-descripcion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="3" placeholder="Describe el sonido que buscas (ej: 'un pad oscuro y atmosfÃ©rico para trap')"></textarea>`;
                            break;
                        case 'marketing-rollout-ia':
                            container.innerHTML = `<input type="text" id="marketing-cancion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Nombre de tu canciÃ³n">`;
                            break;
                        case 'video-concept-ia':
                            container.innerHTML = `<input type="text" id="video-titulo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre de la canciÃ³n"><input type="text" id="video-mood" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="Mood de la canciÃ³n (ej: melancÃ³lico, calle, fiesta)">`;
                            break;
                        case 'storyboard-ia':
                             container.innerHTML = `<textarea id="storyboard-letra" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="4" placeholder="Pega aquÃ­ la letra de tu canciÃ³n..."></textarea>`;
                            break;
                        case 'remix-concept':
                            container.innerHTML = `<input type="text" id="remix-titulo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre de la canciÃ³n original"><input type="text" id="remix-genero" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="GÃ©nero original (ej: Trap)">`;
                            break;
                        case 'media-training-ia':
                            container.innerHTML = `<input type="text" id="media-artista" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Tu nombre artÃ­stico"><input type="text" id="media-cancion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Nombre de tu nueva canciÃ³n"><textarea id="media-mensaje" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="3" placeholder="El mensaje clave que quieres comunicar..."></textarea>`;
                            break;
                        case 'global-release-planner':
                            container.innerHTML = `<input type="text" id="release-paises" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="PaÃ­ses Objetivo (ej: MÃ©xico, EspaÃ±a, Argentina)"><select id="release-genero" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="Urbano Latino">GÃ©nero: Urbano Latino</option><option value="Pop Global">GÃ©nero: Pop Global</option><option value="ElectrÃ³nica">GÃ©nero: ElectrÃ³nica</option></select>`;
                            break;
                        case 'cultural-translator':
                            container.innerHTML = `<textarea id="translator-letra" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="6" placeholder="Pega aquÃ­ la letra original..."></textarea><select id="translator-origen" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2"><option value="EspaÃ±ol de Argentina">Origen: EspaÃ±ol de Argentina</option><option value="EspaÃ±ol de Chile">Origen: EspaÃ±ol de Chile</option><option value="EspaÃ±ol de Colombia">Origen: EspaÃ±ol de Colombia</option><option value="EspaÃ±ol de EspaÃ±a">Origen: EspaÃ±ol de EspaÃ±a</option><option value="EspaÃ±ol de MÃ©xico">Origen: EspaÃ±ol de MÃ©xico</option></select><select id="translator-objetivo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="EspaÃ±ol Neutro (Global)">Objetivo: EspaÃ±ol Neutro (Global)</option><option value="InglÃ©s (Americano)">Objetivo: InglÃ©s (Americano)</option><option value="PortuguÃ©s (Brasil)">Objetivo: PortuguÃ©s (Brasil)</option></select>`;
                            break;
                        case 'royalty-split-simulator':
                            container.innerHTML = `<textarea id="royalty-colaboradores" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="4" placeholder="Ej: Artista (Letra/Voz) - 50%, Productor (Beat) - 50%"></textarea><input type="number" id="royalty-streams" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" placeholder="NÃºmero de Streams (ej: 1000000)">`;
                            break;
                         case 'trend-forecaster':
                            container.innerHTML = `<select id="trend-mercado" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2"><option value="Global">Mercado: Global</option><option value="LatinoamÃ©rica">Mercado: LatinoamÃ©rica</option><option value="EspaÃ±a">Mercado: EspaÃ±a</option><option value="Anglo">Mercado: Anglo</option></select><select id="trend-genero" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="Urbano (Trap, Reggaeton, Drill)">GÃ©nero: Urbano</option><option value="Pop">GÃ©nero: Pop</option><option value="ElectrÃ³nica">GÃ©nero: ElectrÃ³nica</option></select>`;
                            break;
                        case 'collab-architect':
                            container.innerHTML = `<input type="text" id="collab-nombre" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Tu nombre artÃ­stico"><textarea id="collab-descripcion" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="3" placeholder="Describe tu sonido e influencias..."></textarea><select id="collab-objetivo" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2"><option value="llegar a una nueva audiencia">Objetivo: Llegar a nueva audiencia</option><option value="crear un hit de nicho">Objetivo: Crear un hit de nicho</option><option value="experimentar con un nuevo sonido">Objetivo: Experimentar</option></select>`;
                            break;
                        case 'audience-analyzer':
                             container.innerHTML = `<input type="text" id="audience-ciudades" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="Ciudades Principales (ej: Santiago, CDMX, B.A.)"><input type="text" id="audience-demografia" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" placeholder="DemografÃ­a (ej: 65% Hombres, 18-27 aÃ±os)"><textarea id="audience-fuentes" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 mb-2" rows="2" placeholder="Fuentes de Streams (ej: Perfil, Playlists de oyentes...)"></textarea><textarea id="audience-playlists" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="2" placeholder="Playlists donde apareces..."></textarea>`;
                            break;
                        default:
                             container.innerHTML = `<textarea id="tool-prompt-input" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2" rows="4" placeholder="Describe tu idea..."></textarea>`;
                    }
                }
            }
            
            function getToolInputs(tool) {
                 if (tool.type === 'replicate-audio-upload') {
                    const fileInput = document.getElementById('audio-file-input');
                    if (!fileInput || !fileInput.files[0]) return null;
                    return { audio_file: fileInput.files[0] };
                } else if (tool.type === 'replicate-audio') {
                    return { prompt: document.getElementById('tool-prompt-input').value };
                } else if (tool.type === 'gemini-image') {
                    return { artista: document.getElementById('cover-artista').value, titulo: document.getElementById('cover-titulo').value, mood: document.getElementById('cover-mood').value };
                } else if (tool.type === 'hybrid-mastering') {
                    const userTrackInput = document.getElementById('user-track-input');
                    const referenceTrackInput = document.getElementById('reference-track-input');
                    if (!userTrackInput || !userTrackInput.files[0]) return null;
                    return { 
                        userTrack: userTrackInput.files[0],
                        referenceTrack: referenceTrackInput.files[0] || null
                    };
                } else { // Default for gemini-text tools
                    switch (tool.id) {
                        case 'flow-generator':
                            return { tema: document.getElementById('flow-tema').value, flow: document.getElementById('flow-tipo').value, artista: document.getElementById('flow-artista').value };
                        case 'drum-pattern':
                            return { genero: document.getElementById('drum-genero').value };
                        case 'acordes-para-sample':
                            return { descripcion: document.getElementById('acordes-descripcion').value };
                        case 'email-pitch':
                            return { artista: document.getElementById('pitch-artista').value, cancion: document.getElementById('pitch-cancion').value, link: document.getElementById('pitch-link').value, destinatario: document.getElementById('pitch-destinatario').value };
                        case 'hook-optimizer':
                            return { tema: document.getElementById('hook-tema').value };
                        case 'tech-rider-builder':
                            return { nombre: document.getElementById('rider-nombre').value, contacto: document.getElementById('rider-contacto').value, configuracion: document.getElementById('rider-configuracion').value, recinto: document.getElementById('rider-recinto').value };
                        case 'metadata-generator':
                            return { artista: document.getElementById('meta-artista').value, titulo: document.getElementById('meta-titulo').value, genero: document.getElementById('meta-genero').value, mood: document.getElementById('meta-mood').value };
                        case 'modo-genio':
                            return { tema: document.getElementById('genio-tema').value, mentor: document.getElementById('genio-mentor').value };
                        case 'analisis-de-mezcla':
                            return { descripcion: document.getElementById('analisis-descripcion').value, referencia: document.getElementById('analisis-referencia').value };
                        case 'contract-analyzer':
                            return { texto: document.getElementById('contract-texto').value };
                        case 'vocal-preset-ia':
                            return { plugins: document.getElementById('vocal-daw').value, artista: document.getElementById('vocal-artista').value };
                        case 'identidad-de-marca-ia':
                            return { nombre: document.getElementById('brand-nombre').value, temas: document.getElementById('brand-temas').value, color: document.getElementById('brand-color').value };
                        case 'sonido-unico-ia':
                            return { artista1: document.getElementById('sound-artista1').value, artista2: document.getElementById('sound-artista2').value };
                        case 'synth-preset-ia':
                            return { descripcion: document.getElementById('synth-descripcion').value };
                        case 'marketing-rollout-ia':
                            return { cancion: document.getElementById('marketing-cancion').value };
                        case 'video-concept-ia':
                             return { titulo: document.getElementById('video-titulo').value, mood: document.getElementById('video-mood').value };
                        case 'storyboard-ia':
                            return { letra: document.getElementById('storyboard-letra').value };
                        case 'remix-concept':
                            return { titulo: document.getElementById('remix-titulo').value, generoOriginal: document.getElementById('remix-genero').value };
                        case 'media-training-ia':
                            return { artista: document.getElementById('media-artista').value, cancion: document.getElementById('media-cancion').value, mensaje: document.getElementById('media-mensaje').value };
                        case 'global-release-planner':
                            return { paises: document.getElementById('release-paises').value, genero: document.getElementById('release-genero').value };
                        case 'cultural-translator':
                            return { letra: document.getElementById('translator-letra').value, origen: document.getElementById('translator-origen').value, objetivo: document.getElementById('translator-objetivo').value };
                        case 'royalty-split-simulator':
                            return { colaboradores: document.getElementById('royalty-colaboradores').value, streams: document.getElementById('royalty-streams').value };
                        case 'trend-forecaster':
                            return { mercado: document.getElementById('trend-mercado').value, genero: document.getElementById('trend-genero').value };
                        case 'collab-architect':
                            return { nombre: document.getElementById('collab-nombre').value, descripcion: document.getElementById('collab-descripcion').value, objetivo: document.getElementById('collab-objetivo').value };
                        case 'audience-analyzer':
                             return { ciudades: document.getElementById('audience-ciudades').value, demografia: document.getElementById('audience-demografia').value, fuentes: document.getElementById('audience-fuentes').value, playlists: document.getElementById('audience-playlists').value };
                        default:
                            const inputEl = document.getElementById('tool-prompt-input');
                            return inputEl ? { prompt: inputEl.value } : {};
                    }
                }
            }

            function closeModal(modal) {
                modal.classList.remove('active');
            }

            // --- LÃ“GICA DE HERRAMIENTAS Y API ---
            async function handleToolExecution(tool) {
                const inputs = getToolInputs(tool);
                if (!inputs) {
                    alert("Por favor, selecciona un archivo.");
                    return;
                }
                
                if (tool.type.startsWith('replicate') && !YOUR_REPLICATE_API_KEY) {
                    alert("Error de configuraciÃ³n: La API Key de Replicate no estÃ¡ definida.");
                    return;
                }
                if (tool.type.startsWith('gemini') && !YOUR_GEMINI_API_KEY) {
                    alert("Error de configuraciÃ³n: La API Key de Gemini no estÃ¡ definida.");
                    return;
                }

                dom.toolModalSubmitText.textContent = 'Creando...';
                dom.toolModalLoader.classList.remove('hidden');
                dom.toolModalSubmit.disabled = true;
                dom.toolModalOutput.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div><p class="ml-4">La IA estÃ¡ trabajando...</p></div>`;
                dom.downloadPdfButton.classList.add('hidden');
                dom.downloadMidiButton.classList.add('hidden');

                try {
                    if (tool.type === 'gemini-text' || tool.type === 'gemini-midi') {
                        await handleTextGeneration(tool, inputs);
                    } else if (tool.type === 'gemini-image') {
                        await handleImageGeneration(tool, inputs);
                    } else if (tool.type.startsWith('replicate')) {
                        await handleReplicateExecution(tool, inputs);
                    } else if (tool.type === 'hybrid-mastering') {
                        await handleHybridMastering(tool, inputs);
                    }

                    if (userState.credits !== Infinity) {
                        userState.credits -= tool.cost;
                        saveUserState();
                        updateUI();
                    }
                } catch (error) {
                    dom.toolModalOutput.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                } finally {
                    dom.toolModalSubmitText.textContent = 'Generar';
                    dom.toolModalLoader.classList.add('hidden');
                    dom.toolModalSubmit.disabled = false;
                }
            }
            
            // --- LÃ“GICA DE MASTERING DE Ã‰LITE ---
            async function handleHybridMastering(tool, inputs) {
                // Paso 1: AnÃ¡lisis EstratÃ©gico con Gemini
                let analysisPrompt;
                if (inputs.referenceTrack) {
                    analysisPrompt = `ActÃºa como un ingeniero de mastering de clase mundial como Luca Pretolesi. Voy a masterizar una canciÃ³n llamada "${inputs.userTrack.name}". Quiero que suene como la canciÃ³n de referencia, "${inputs.referenceTrack.name}". Describe en 3 puntos clave y accionables quÃ© ajustes sÃ³nicos (EQ, compresiÃ³n, imagen estÃ©reo) aplicarÃ­as para lograr ese sonido de referencia. SÃ© tÃ©cnico pero conciso.`;
                } else {
                    analysisPrompt = `ActÃºa como un ingeniero de mastering de clase mundial como Luca Pretolesi. Voy a masterizar una canciÃ³n llamada "${inputs.userTrack.name}". No tengo una referencia. Describe en 3 puntos clave y accionables un plan de mastering estÃ¡ndar de la industria para darle potencia, claridad y un carÃ¡cter comercial.`;
                }
                
                const masteringBrief = await callGeminiAPI(analysisPrompt);
                dom.toolModalOutput.innerHTML = `<h3>Informe del Ingeniero IA:</h3>${parseToHTML(masteringBrief)}<div class="flex justify-center items-center h-full mt-4"><div class="loader"></div><p class="ml-4">Aplicando master a tu canciÃ³n...</p></div>`;

                // Paso 2: Procesamiento de Audio con Replicate
                const replicateTool = {
                    model: 'cjwbw/audiotools-v1:9a73e059728551733696536675a6493dfd08b3303530f78275508be61036815a',
                    input: (p) => ({ input_audio: p.audio_file })
                };
                const audioResultUrl = await processReplicateAudio(replicateTool, { audio_file: inputs.userTrack });

                // Paso 3: Mostrar resultado final
                dom.toolModalOutput.innerHTML = `<h3>Informe del Ingeniero IA:</h3>${parseToHTML(masteringBrief)}<h3 class="mt-6">Resultado Final:</h3><audio controls class="w-full" src="${audioResultUrl}"></audio>`;
            }

            async function processReplicateAudio(tool, inputs) {
                const base64Audio = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(inputs.audio_file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
                const finalInput = tool.input({ audio_file: base64Audio });

                const startResponse = await fetch('https://api.replicate.com/v1/predictions', {
                    method: 'POST',
                    headers: { 'Authorization': `Token ${YOUR_REPLICATE_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version: tool.model, input: finalInput })
                });

                let prediction = await startResponse.json();
                if (startResponse.status !== 201) throw new Error(prediction.detail || "Error al iniciar la tarea en Replicate.");

                while (prediction.status !== 'succeeded' && prediction.status !== 'failed') {
                    await new Promise(resolve => setTimeout(resolve, 2500));
                    const pollResponse = await fetch(`https://api.replicate.com/v1/predictions/${prediction.id}`, { headers: { 'Authorization': `Token ${YOUR_REPLICATE_API_KEY}` } });
                    prediction = await pollResponse.json();
                    if (pollResponse.status !== 200) throw new Error(prediction.detail || "Error al consultar el estado de la tarea.");
                }

                if (prediction.status === 'failed') throw new Error("La IA no pudo procesar el audio. Intenta con otro archivo.");
                
                return prediction.output;
            }

            // --- LÃ“GICA PARA REPLICATE (MÃºsica, Stems, Ruido) ---
            async function handleReplicateExecution(tool, inputs) {
                const audioResultUrl = await processReplicateAudio(tool, inputs);
                displayReplicateResult(tool, audioResultUrl);
            }

            function displayReplicateResult(tool, output) {
                dom.toolModalOutput.innerHTML = ''; // Limpiar loader
                
                if (tool.id === 'stem-splitter') {
                    let outputHtml = '<p class="font-bold text-lg mb-4">Â¡Stems listos para descargar!</p>';
                    const stems = { 'Vocals': output.vocals, 'Bass': output.bass, 'Drums': output.drums, 'Other': output.other };
                    for (const [name, url] of Object.entries(stems)) {
                        outputHtml += `
                            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg mb-2">
                                <span>${name}.wav</span>
                                <a href="${url}" target="_blank" download class="download-stem-button font-bold py-1 px-3 rounded-lg text-sm">Descargar</a>
                            </div>`;
                    }
                    dom.toolModalOutput.innerHTML = outputHtml;
                } else {
                    dom.toolModalOutput.innerHTML = `<p class="font-bold text-lg mb-2">Â¡Resultado listo!</p><audio controls class="w-full" src="${output}"></audio>`;
                }
            }


            // --- LÃ“GICA DE GEMINI (TEXTO E IMAGEN) ---
            async function handleTextGeneration(tool, inputs) {
                const prompt = tool.prompt(inputs);
                const resultText = await callGeminiAPI(prompt);
                
                if (tool.type === 'gemini-midi') {
                    try {
                        const midiData = JSON.parse(resultText);
                        let html = `<h3>GuÃ­a de ProgramaciÃ³n:</h3><p>${midiData.guia}</p>`;
                        html += `<h3>Tips de Sonido:</h3><p>${midiData.sonidos}</p>`;
                        html += `<h3>Groove Secreto:</h3><p>${midiData.groove}</p>`;
                        dom.toolModalOutput.innerHTML = html;
                        
                        dom.downloadMidiButton.classList.remove('hidden');
                        dom.downloadMidiButton.onclick = () => {
                            const track = new MidiWriter.Track();
                            midiData.pattern.forEach(note => {
                                track.addEvent(new MidiWriter.NoteEvent({
                                    pitch: [note.note],
                                    startTick: note.tick,
                                    duration: note.duration,
                                    velocity: Math.floor(note.velocity * 100)
                                }));
                            });
                            const write = new MidiWriter.Writer(track);
                            const dataUri = write.dataUri();
                            const a = document.createElement('a');
                            a.href = dataUri;
                            a.download = 'soniclab_pattern.mid';
                            a.click();
                        };

                    } catch(e) {
                         console.error("Error parsing MIDI JSON:", e);
                         dom.toolModalOutput.innerHTML = parseToHTML(resultText);
                    }
                } else {
                    dom.toolModalOutput.innerHTML = parseToHTML(resultText);
                }

                dom.downloadPdfButton.classList.remove('hidden');
                dom.downloadPdfButton.onclick = () => generatePDF(tool, resultText);
            }

            async function handleImageGeneration(tool, inputs) {
                dom.toolModalOutput.innerHTML = '<p>Generando concepto de arte...</p><div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
                const promptForPrompt = tool.prompt(inputs);
                const imagePrompt = await callGeminiAPI(promptForPrompt);
                
                dom.toolModalOutput.innerHTML = `<p class="mb-2 text-sm"><strong>Prompt Generado:</strong> ${imagePrompt.split('**Kit')[0]}</p><p>Creando imagen...</p><div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                
                const imageUrl = await callImageAPI(imagePrompt.split('**Kit')[0]); // Usamos solo el prompt principal
                if (imageUrl) {
                    dom.toolModalOutput.innerHTML = `<img src="${imageUrl}" class="w-full h-auto rounded-lg" alt="Portada generada por IA">`;
                } else {
                    throw new Error('Error al generar la imagen.');
                }
            }

            async function callGeminiAPI(prompt) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${YOUR_GEMINI_API_KEY}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Error desconocido de la API de texto.');
                    }
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una respuesta.";
                } catch (error) {
                    console.error("Error en llamada a Gemini:", error);
                    throw new Error(`Error al conectar con la IA de texto: ${error.message}`);
                }
            }
            
            async function callImageAPI(prompt) {
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${YOUR_GEMINI_API_KEY}`;
                 const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };

                 try {
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });
                      if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.error?.message || 'Error desconocido de la API de imagen.');
                     }
                     const result = await response.json();
                     if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                         return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                     }
                     return null;
                 } catch (error) {
                     console.error("Error en llamada a Imagen:", error);
                     return null;
                 }
            }

            // --- LÃ“GICA DE UTILIDADES (Sin cambios) ---
            function parseToHTML(text) {
                let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/### (.*?)\n/g, '<h3 class="text-yellow-400 text-lg font-bold mt-4 mb-2">$1</h3>');
                html = html.replace(/(\d+)\.\s\*\*(.*?)\*\*/g, '<h3 class="text-yellow-400 text-lg font-bold mt-4 mb-2">$2</h3>');
                html = html.replace(/\* (.*?)\n/g, '<li class="relative pl-5 before:content-[\'-\'] before:absolute before:left-0 before:text-pink-500">$1</li>');
                html = html.replace(/\n/g, '<br>');
                return html;
            }

            function generatePDF(tool, textContent) {
                const doc = new jsPDF();
                const margin = 15;
                const pageWidth = doc.internal.pageSize.getWidth();
                const usableWidth = pageWidth - (margin * 2);
                doc.setFontSize(22);
                doc.setFont("helvetica", "bold");
                doc.text("SonicLab", pageWidth / 2, margin, { align: 'center' });
                doc.setFontSize(16);
                doc.setFont("helvetica", "normal");
                doc.text(`${tool.icon} ${tool.name}`, pageWidth / 2, margin + 10, { align: 'center' });
                doc.setLineWidth(0.5);
                doc.line(margin, margin + 15, pageWidth - margin, margin + 15);
                doc.setFontSize(11);
                const cleanedText = textContent.replace(/\*\*/g, '').replace(/###/g, '\n').replace(/\*/g, '  -');
                const splitText = doc.splitTextToSize(cleanedText, usableWidth);
                doc.text(splitText, margin, margin + 30);
                doc.save(`${tool.name.replace(/ /g, '_')}_Resultado.pdf`);
            }
            
            function setupQRCodes() {
                const planLinks = {
                    'pro-mensual': 'https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=61d8e63e69e344e59370fd7e89b96f9c',
                    'diamante-mensual': 'https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=0b397bb6555942e084ca042e71d2a242',
                    'pro-anual': 'https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=97bffffdac9c498d8019054a27a79bf1',
                    'diamante-anual': 'https://www.mercadopago.cl/subscriptions/checkout?preapproval_plan_id=0ce6c115290a4a478b00f3b8b0e31f34'
                };

                for (const [id, link] of Object.entries(planLinks)) {
                    const qrContainer = document.getElementById(`qr-${id}`);
                    if (qrContainer) {
                        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}&bgcolor=ffffff&color=000000&margin=10`;
                        const qrImage = document.createElement('img');
                        qrImage.src = qrCodeUrl;
                        qrImage.alt = `CÃ³digo QR para el plan ${id}`;
                        qrImage.className = "rounded-md w-full h-auto";
                        qrContainer.innerHTML = '';
                        qrContainer.appendChild(qrImage);
                    }
                }
            }

            function setupEventListeners() {
                dom.closeToolModalBtn.addEventListener('click', () => closeModal(dom.toolModal));
                window.addEventListener('click', (e) => {
                    if (e.target === dom.toolModal) closeModal(dom.toolModal);
                });
                
                dom.adminGenerateLinkBtn.addEventListener('click', () => {
                    const plan = dom.adminPlan.value;
                    const credits = dom.adminCredits.value;
                    const baseUrl = window.location.href.split('#')[0];
                    let grantUrl = `${baseUrl}#grant-${plan.toLowerCase()}`;
                    if (credits) {
                        grantUrl += `-${credits}`;
                    }
                    dom.adminGeneratedLink.value = grantUrl;
                    dom.adminLinkContainer.classList.remove('hidden');
                });

                dom.adminCopyLinkBtn.addEventListener('click', () => {
                    dom.adminGeneratedLink.select();
                    document.execCommand('copy');
                    alert('Enlace copiado al portapapeles');
                });
            }

            // --- INICIAR LA APLICACIÃ“N ---
            init();
        });
    </script>
</body>
</html>
